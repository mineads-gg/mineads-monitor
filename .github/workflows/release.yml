name: Publish Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release'
        required: true
      after-version:
        description: 'Snapshot version after release'
        required: true

jobs:
  set-release-version:
    uses: mineads-gg/mineads-monitor/.github/workflows/set-version.yml@main
    permissions:
      contents: write
    with:
      version: ${{ inputs.version }}
    secrets: inherit

  build:
    needs: set-release-version
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: ${{ github.ref }}
      - name: Validate Gradle wrapper
        uses: gradle/actions/wrapper-validation@v4
      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
      - name: Build with Gradle and publish
        run: ./gradlew build test publish --stacktrace --scan
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Build Changelog
        id: github_release
        uses: mikepenz/release-changelog-builder-action@v5
        with:
          mode: COMMIT
          toTag: ${{ github.ref }}
          configurationJson: |
            {
              "template": "#{{CHANGELOG}}",
              "commit_template": "- [`#{{SHORT_MERGE_SHA}}`](https://github.com/mineads-gg/mineads-monitor/commit/#{{MERGE_SHA}}) #{{TITLE}}",
              "categories": [
                {
                    "title": "## ðŸš€ Features",
                    "labels": ["feat", "feature"]
                },
                {
                    "title": "## ðŸ› Fixes",
                    "labels": ["fix", "bug"]
                },
                {
                    "title": "## ðŸŽï¸ Performance",
                    "labels": ["perf"]
                },
                {
                    "title": "## ðŸ— Refactor",
                    "labels": ["refactor"]
                },
                {
                    "title": "## ðŸ“ Documentation",
                    "labels": ["docs"]
                },
                {
                    "title": "## ðŸ”¨ Build",
                    "labels": ["build", "chore", "ci"]
                },
                {
                    "title": "## ðŸ’… Style",
                    "labels": ["style"]
                },
                {
                    "title": "## ðŸ§ª Tests",
                    "labels": ["test"]
                },
                {
                    "title": "## ðŸ’¬ Other",
                    "labels": []
                },
                {
                  "title": "## ðŸ“¦ Dependencies",
                  "labels": ["dependencies"]
                }
              ],
              "label_extractor": [
                {
                  "pattern": "^(build|chore|ci|docs|feat|fix|perf|refactor|revert|style|test){1}(\\([\\w\\-\\.]+\\))?(!)?: ([\\w ])+([\\s\\S]*)",
                  "on_property": "title",
                  "target": "$1"
                }
              ],
              "custom_placeholders": [
                {
                  "name": "SHORT_MERGE_SHA",
                  "source": "MERGE_SHA",
                  "transformer": {
                    "pattern": "^([0-9a-f]{7})[0-9a-f]*$",
                    "target": "$1"
                  }
                }
              ]
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to Modrinth (Bukkit)
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: mineads-monitor
          modrinth-featured: true
          modrinth-unfeature-mode: subset
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}

          files: |
            build/libs/MineAdsMonitor-Bukkit-${{ inputs.version }}.jar

          name: MineAdsMonitor ${{ inputs.version }}
          version: ${{ inputs.version }}
          version-type: release
          changelog: ${{ steps.github_release.outputs.changelog }}

          loaders: |
            bukkit
            folia
            paper
            purpur
            spigot
          game-versions: |
            >=1.8.0
          game-version-filter: releases

          retry-attempts: 2
          retry-delay: 10000
          fail-mode: fail

      - name: Publish to Modrinth (BungeeCord)
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: mineads-monitor
          modrinth-featured: true
          modrinth-unfeature-mode: subset
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}

          files: |
            build/libs/MineAdsMonitor-Bungee-${{ inputs.version }}.jar

          name: MineAdsMonitor ${{ inputs.version }}
          version: ${{ inputs.version }}
          version-type: release
          changelog: ${{ steps.github_release.outputs.changelog }}

          loaders: |
            bungeecord
            waterfall
          game-versions: |
            >=1.8.0
          game-version-filter: releases

          retry-attempts: 2
          retry-delay: 10000
          fail-mode: fail

      - name: Publish to Modrinth (Velocity)
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: mineads-monitor
          modrinth-featured: true
          modrinth-unfeature-mode: subset
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}

          files: |
            build/libs/MineAdsMonitor-Velocity-${{ inputs.version }}.jar

          name: MineAdsMonitor ${{ inputs.version }}
          version: ${{ inputs.version }}
          version-type: release
          changelog: ${{ steps.github_release.outputs.changelog }}

          loaders: |
            velocity
          game-versions: |
            >=1.8.0
          game-version-filter: releases

          retry-attempts: 2
          retry-delay: 10000
          fail-mode: fail

      - name: Publish Release on GitHub
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          github-tag: ${{ inputs.version }}
          github-generate-changelog: false
          github-draft: false
          github-prerelease: false
          github-commitish: main
          github-token: ${{ secrets.GITHUB_TOKEN }}

          files: |
            build/libs/MineAdsMonitor-Bukkit-${{ inputs.version }}.jar
            build/libs/MineAdsMonitor-Bungee-${{ inputs.version }}.jar
            build/libs/MineAdsMonitor-Velocity-${{ inputs.version }}.jar

          name: MineAdsMonitor ${{ inputs.version }}
          version: ${{ inputs.version }}
          version-type: release
          changelog: |
            [![modrinth](https://cdn.jsdelivr.net/npm/@intergrav/devins-badges@3/assets/cozy/available/modrinth_vector.svg)](https://modrinth.com/plugin/mineads-monitor/version/${{ inputs.version }}) [![hangar](https://cdn.jsdelivr.net/npm/@intergrav/devins-badges@3/assets/cozy/available/hangar_vector.svg)](https://hangar.papermc.io/MineAds/MineAdsMonitor/versions/${{ inputs.version }})

            ${{ steps.github_release.outputs.changelog }}

          retry-attempts: 2
          retry-delay: 10000
          fail-mode: fail

      - name: Upload to Hangar
        uses: benwoo1110/hangar-upload-action@v1
        with:
          api_token: ${{ secrets.HANGAR_TOKEN }}
          slug: 'MineAdsMonitor'
          version: ${{ inputs.version }}
          channel: release
          description: ${{ steps.github_release.outputs.changelog }}
          files: |
            [
              {
                "path": "build/libs/MineAdsMonitor-Bukkit-${{ inputs.version }}.jar",
                "platforms": ["PAPER"]
              },
              {
                "path": "build/libs/MineAdsMonitor-Bungee-${{ inputs.version }}.jar",
                "platforms": ["WATERFALL"]
              },
              {
                "path": "build/libs/MineAdsMonitor-Velocity-${{ inputs.version }}.jar",
                "platforms": ["VELOCITY"]
              }
            ]

      - name: Discord Webhook Action
        uses: tsickert/discord-webhook@v7.0.0
        with:
          webhook-url: ${{ secrets.WEBHOOK_URL }}
          content: <@&850705047938793503> New MineAdsMonitor version released!
          embed-title: MineAdsMonitor ${{ inputs.version }}
          embed-description: MineAdsMonitor ${{ inputs.version }} has been released! Changelog and download can be found at https://modrinth.com/plugin/mineadsmonitor/version/${{ inputs.version }}
          embed-color: 16641028
          embed-thumbnail-url: https://raw.githubusercontent.com/mineads-gg/mineads-monitor/refs/heads/main/images/logo.png

  set-after-version:
    needs: build
    uses: mineads-gg/mineads-monitor/.github/workflows/set-version.yml@main
    permissions:
      contents: write
    with:
      version: ${{ inputs.after-version }}
    secrets: inherit
